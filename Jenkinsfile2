#!groovy
import groovy.io.FileType
def componentName
def componentTag
def lista
def componentAppName
def directorio = "/tmp/archivos"



pipeline {
	agent any
	   	environment {

		SCM_URL = "https://github.com/nazpot01/Pruebas.git"
	        SCM_CREDENTIALS = "123456789"
		SCM_BRANCH = "${BRANCH_NAME}"
		BRANCH_NAME= "RQ02" //variable
		}
		
	stages {
		stage('Repository') {
                steps {
			echo "[EXEC] - Obtener c√≥digo fuente desde repositorio Git"
				}
			}
	stage('Copy'){
		steps {
			script{
				sh"pwd"
				sh"git checkout origin/${BRANCH_NAME}"
				sh"mkdir /var/lib/jenkins/workspace/unicoprueba/archivos"
				sh"git diff --name-only origin/master | while read -r line; do cp \${line} /var/lib/jenkins/workspace/unicoprueba/archivos ; done"
				def dir = new File("/var/lib/jenkins/workspace/unicoprueba/archivos")
				dir.eachFile{
					componentAppName = it.getName().toString().substring(0,it.getName().toString().length()-4)
					componentTag=  it.getName().toString().substring(it.getName().toString().length()-3,it.getName().toString().length()) 
					artefact = sh(returnStdout: true, script: "(ls -p ${dir} | grep ${componentAppName}) || true")
					//println artefact
				}
					try {
						for(int i = 0; i < componentAppName.size(); i++) {
						println 'primer ingreso'
						componentTagCurrent = componentTag
					        componentAppNameCurrent = componentAppName
						println ' extension ' + componentTagCurrent
						println  ' nombre ' + componentAppNameCurrent
						   step([$class: 'UCDeployPublisher',
							siteName: 'Connect_Jenkins_Ucd',
							component: [
							    $class: 'com.urbancode.jenkins.plugins.ucdeploy.VersionHelper$VersionBlock',
							    componentName: componentAppName,
								componentTag: componentTag,
							    createComponent: [
								$class: 'com.urbancode.jenkins.plugins.ucdeploy.ComponentHelper$CreateComponentBlock',
								componentTemplate: '',
								componentApplication: 'UNICO_MANTENIMIENTO'
							    ],
							    delivery: [
								$class: 'com.urbancode.jenkins.plugins.ucdeploy.DeliveryHelper$Push',
								pushVersion: "${BUILD_NUMBER}",
								baseDir: '/var/lib/jenkins/workspace/unicoprueba/archivos',
								fileIncludePatterns: componentTagCurrent+'.'+componentTagCurrent,
								fileExcludePatterns: '',
								pushProperties: '',
								pushDescription: 'Pushed from Jenkins',
								pushIncremental: false
							    ]
							]
						    ])
						}
						} catch(Exception e) {
							println e.printStackTrace();
							println 'Execion' + e.getMessage()
						}
					sh"rm -R ${dir}"
				}
			}
		}
		
	}
}
