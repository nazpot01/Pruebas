#!groovy
def componentName
def componentTag
def lista
def componentAppName



pipeline {
	agent any
	   	environment {

		SCM_URL = "https://github.com/nazpot01/Pruebas.git"
	        SCM_CREDENTIALS = "123456789"
		SCM_BRANCH = "${BRANCH_NAME}"
		BRANCH_NAME= "RQ01" //variable
		}
		
	stages {
		stage('Test') {
                steps {
                    echo "[EXEC] - Obtener c√≥digo fuente desde repositorio Git"
				}
			}
	stage('Copy'){
		steps {
			script{
				sh"pwd"
				sh"git checkout origin/${BRANCH_NAME}"
				lista=sh(script: 'git diff --name-only origin/master  | grep -Ex ".*\\.[a-z]+"', returnStdout : true ).split('\n');
				a = lista.size()
				println a
				componentTag = new String[a]
				componentAppName = new String[a]
				
				for(int i = 0; i < a; i++){
					componentTag[i] = lista[i].substring(lista[i].lastIndexOf('.') + 1, lista[i].length()).toUpperCase() // somefolder/app.ear -> EAR
					componentAppName[i] = lista[i].substring(Math.max(0, lista[i].lastIndexOf('/') + 1), lista[i].lastIndexOf('.')) // somefolder/app.ear -> app
					//println componentTag[i]
					println componentTag[i]
					//println componentAppName[i]
				}
			}
		}
	}
		
		stage('UPLOAD_COMPONENTS') {
			steps {
				script {
					for(int i = 0; i < componentAppName.size(); i++) {
						componentTagCurrent = componentTag[i]
					        componentAppNameCurrent = componentAppName[i]
						println componentTagCurrent + ' ext '
						println componentAppNameCurrent + ' name '
						try { println + ' voy por el try sin excepciones '
						step([$class   : 'UCDeployPublisher',
							siteName : 'https://administrador-virtualbox:8443',
							createcomponent: [
								$class		: 'com.urbancode.jenkins.plugins.ucdeploy.VersionHelper$VersionBlock',
								componentName	: "${componentAppNameCurrent}",
								componentTag	: "${componentTagCurrent}",
								createComponent: [
									$class		: 'com.urbancode.jenkins.plugins.ucdeploy.ComponentHelper$CreateComponentBlock',
									componentApplication: 'UNICO MANTENIMIENTO'
								],
								delivery       : [
									$class             : 'com.urbancode.jenkins.plugins.ucdeploy.DeliveryHelper$Push',
									pushVersion        : "1",
									baseDir            : "var/lib/jenkins/workspace/unicoprueba",
									pushDescription    : 'Entrega de artefactos'
								]
							]
						])
						} catch(Exception e) {
							e.printStackTrace();
							println e + ' exception '
						}
					}
				}
			}
		}
		
	}
}
